---
title: "Analysis of Carbon Dioxide (1997 & Present)"
author: "Violet Davis, Yuri Kinakin, W. Sean McFetridge and Emanuel Mejia"
output: bookdown::pdf_document2
header-includes:
  - \usepackage{caption}
fontsize: 11pt
geometry: margin=1in
toc: false
---

```{r load packages, results='hide', message=FALSE, warning=FALSE, echo=FALSE}
Sys.setlocale("LC_TIME", "English")
library(tidyverse)
library(magrittr)
library(patchwork)
library(lubridate)
library(tsibble)
library(feasts)
library(forecast)
library(sandwich)
library(lmtest)
library(nycflights13)
library(blsR)
library(lubridate)
library(zoo)
library(fable)
library(tseries)
library(plyr)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(scales)
library(gridExtra)
library(GPFDA)
library(reshape)
library(imputeTS)
library(stlplus)
```

# 1997 Report

## Introduction
Charles D. Keeling discovered that the content of carbon dioxide in the atmosphere moves in a predictable and seasonal pattern with an upward trend. Carbon dioxide is a greenhouse gas that is transparent to visible light while being partially reflective to infrared-radiation, so as the levels of carbon dioxide increase the average global temperature will experience a corresponding increase. This rising temperature can have serious impacts on the environment and on human health. Therefore, the analysis of CO$_{2}$ data are critical to make informed decisions on how to address these changes to the climate. At the time of this paper (1997), the US government has not yet implemented any federal laws targeting CO$_{2}$ emissions.

We aim to develop a model to predict the growth of CO$_{2}$ in the atmosphere. We will analyze several models within this report, focusing on linear time trend and ARIMA time series models. These results should be reviewed at a later date to determine model performance, and hopefully to assess the impact of current and future legislation on reducing the emission of carbon dioxide into the atmosphere.

## CO$_{2}$ Data

```{r convert co2 package to tsibble, echo=FALSE}
#Load package and convert to long format
co2_mm_1997 <- tsibble::as_tsibble(datasets::co2)  %>%
    dplyr::rename(
    "time_index" = "index",
    "average" = "value"
  )

#Fill gaps
co2_mm_1997 <- fill_gaps(co2_mm_1997, .full=TRUE)
```

The data analyzed is from the $Global\ Monitoring\ Laboratory$, which was collected at Mauna Loa Observatory in Hawaii. As per the [laboratory's website](https://gml.noaa.gov/ccgg/about/co2_measurements_ndir.html), they note that these CO$_{2}$ measurements represent a robust baseline of global atmospheric CO$_{2}$ concentration for three reasons:

1. The Observatory is near the summit of Mauna Loa at an altitude of 3400 m, making it well situated to measure air masses that are representative of very large areas.
2. All of the instruments are rigorously and frequently calibrated.
3. Ongoing comparisons of independent measurements at the same site allow measurement of variability and accuracy, which is generally better than 0.2 ppm.

Data are continuously collected by an infrared absorption spectroscopy instrument and reported as the "mole fraction" of CO$_{2}$ in dry air, defined as the number of carbon dioxide molecules in a given number of molecules of air after removal of water vapor; this is more commonly known as the "concentration" of CO$_{2}$ in the air.  When we look at aggregated amounts (e.g. the monthly concentration), we take that as the average amount measured during a set period of time versus a single point value during each time period.  

Upon loading the results, we noted there were five months with no reported values (two in 1958 and three in 1964). These rows were removed from the data set and treated as "N/A". Three plots are shown below: a time series of average monthly values from 1958 to 1997, the average month rates during 1997, and the change in average annual co2 for each year (i.e. the growth).

```{r initial plots, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, fig.height=7}
p1 <- co2_mm_1997 %>%
  ggplot(aes(x = time_index, y = average)) +
  geom_line(
    size = 0.8,
    color = "cornflowerblue"
  ) +
  geom_smooth() +
  labs(
      title = "Average CO2 (PPM)",
      subtitle = "by Month - 1958 to 1997",
      x = "Date",
      y = "Average PPM"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 22,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

p2 <- co2_mm_1997 %>%
  filter_index("1997-01" ~ "1997-12") %>%
  ggplot(aes(x = time_index, y = average)) +
  geom_line() +
  geom_smooth() +
  labs(
      title = "Average CO2 (PPM)",
      subtitle = "by Month - 1997",
      x = "Date",
      y = "Average PPM"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 22,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

p3 <- data.frame(co2_mm_1997) %>%
  dplyr::mutate(
    year_index = c(lubridate::year(time_index))
  ) %>%
  dplyr::group_by(
     year_index
  ) %>%
  dplyr::summarize(
    annual_co2 = mean(average)
  ) %>%
  tsibble::as_tsibble(index = year_index) %>%
  ggplot(
    aes(
      x = year_index, 
      y = c(NA, diff(annual_co2))
      )
    ) +
  geom_line(
    size = 0.8,
    color = "cornflowerblue"
  ) +
  geom_smooth(
    method = lm
    ) +
  labs(
      title = "Growth in CO2 (PPM)",
      subtitle = "by Year",
      x = "Year",
      y = "Growth in CO2 (per Year)"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 22,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

grid.arrange(p1, p2, p3, nrow = 1, ncol = 3)
```
From the graphs we can clearly see the data is non-stationary, with a strong upward trend overlain by a seasonal component. This is consistent with the findings from Charles D. Keeling in his original research study. The second graph is single year timeseries plot of CO$_{2}$ PPM by month, which shows there is the highest average concentration of CO2 in the atmosphere from March to July, and the lowest from August to November. Lastly, from the growth plot we can see a steady increase in growth over the years. This means that the rate of increase is not stationary, but rather is increasing over time.

## Model Development

In order to predict the amount of carbon dioxide in the atmosphere we've developed two different classes of models. The first are a series of linear models and the second are a series of ARIMA models. Details of these models are summarized below. 

### Linear Time Trend Model

We ran four different linear models: 

1. $Simple\ Linear: average = trend$
2. $Quadratic\ Linear: average = trend + trend^2$
3. $Logged\ Linear: log(average) = trend$
4. $Seasonal\ Linear: average = trend + trend^2 + season$

```{r four models 1997, echo=FALSE, warning=FALSE}
simple_linear <- co2_mm_1997 %>% 
  model(trend_model = TSLM(average ~ time_index))

quadratic_linear <- co2_mm_1997 %>% 
  model(trend_model = TSLM(average ~ trend() + I(trend()^2)))

logged_linear <- co2_mm_1997 %>% 
  model(trend_model = TSLM(log(average) ~ time_index))

seasonal_linear <- co2_mm_1997 %>%
  model(trend_model = TSLM(average ~ trend() + I(trend()^2) + season()))
```
Each of these models are plotted below, including a projection out to 2020. The logged Linear model is only included for illustration, as when we look at the time series we don't notice a particular increase in stationary variance over time and would not suspect the logged model to be useful. 

```{r four linear models plotted, echo=FALSE, warning=FALSE, message=FALSE, fig.height=3.5}
start_date <- as_date(max(co2_mm_1997$time_index))
end_date <- as_date("2020-12-31")

new_dates <- data.frame(seq(start_date, end_date, by = 'month')) %>%
  dplyr::rename(
    time_index = names(.)[1]
  ) %>%
  tsibble::as_tsibble(index = time_index)

p1 <- co2_mm_1997 %>%
  ggplot(aes(x = time_index)) +
  geom_line(aes(y = average, color="Data")) +
  geom_line(data=augment(simple_linear), aes(y=.fitted, color="Simple Linear")) +
  labs(y = "Average CO2",
       x = "Date",
       title = "Simple Linear Model") +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 12,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 9,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  ) + 
  autolayer(forecast(simple_linear, new_data = new_dates), colour="blue")

p2 <- co2_mm_1997 %>%
  ggplot(aes(x = time_index)) +
  geom_line(aes(y = average, color="Data")) +
  geom_line(data=augment(quadratic_linear), aes(y=.fitted, color="Quadratic Linear")) +
  labs(y = "Average CO2",
       x = "Date",
       title = "Quadratic Linear Model") +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 12,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 9,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  ) + 
  autolayer(forecast(quadratic_linear, h = 276), colour="blue")

p3 <- co2_mm_1997 %>%
  ggplot(aes(x = time_index)) +
  geom_line(aes(y = average, color="Data")) +
  geom_line(data=augment(logged_linear), aes(y=.fitted, color="Logged Linear")) +
  labs(y = "Average CO2",
       x = "Date",
       title = "Logged Linear Model") +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 12,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 9,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  ) + 
  autolayer(forecast(logged_linear, new_data = new_dates), colour="blue")

p4 <- co2_mm_1997 %>%
  ggplot(aes(x = time_index)) +
  geom_line(aes(y = average, color="Data")) +
  geom_line(data=augment(seasonal_linear), aes(y=.fitted, color="Seasonal Linear")) +
  labs(y = "Average CO2",
       x = "Date",
       title = "Seasonal Linear Model") +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 12,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 9,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  ) + 
  autolayer(forecast(seasonal_linear, h = 276), colour="blue")

grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)
```
From the graphs above, we can see that the seasonal model appears to fit the data the best, and the simple linear model appears to fit the worst. As stated previously, there doesn't appear to be much gained by using a logged model as the results are similar to the quadratic model. However, we also want to review the standardized residuals vs. fitted values to ensure they're reasonable:

```{r residual plots for linear models, echo=FALSE, warning=FALSE, message=FALSE, fig.height=3.5}
p1 <- augment(simple_linear) %>%
  ggplot(aes(x = .fitted, y = .innov)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept=c(3, 2, -2, -3), color = "red", linetype = "dashed") +
  labs(
      title = "Simple Linear Model",
      subtitle = "Residuals vs. Fitted",
      x = "",
      y = "Standardized \n Pearson residuals"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 11,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 8,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  )

p2 <- augment(quadratic_linear) %>%
  ggplot(aes(x = .fitted, y = .innov)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept=c(3, 2, -2, -3), color = "red", linetype = "dashed") +
  labs(
      title = "Quadratic Linear Model",
      subtitle = "Residuals vs. Fitted",
      x = "",
      y = ""
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 11,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 8,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  )

p3 <- augment(logged_linear) %>%
  ggplot(aes(x = .fitted, y = .innov)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  labs(
      title = "Logged Linear Model",
      subtitle = "Residuals vs. Fitted",
      x = "Fitted values",
      y = "Standardized \n Pearson residuals"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 11,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 8,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  )

p4 <- augment(seasonal_linear) %>%
  ggplot(aes(x = .fitted, y = .innov)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept=c(3, 2, -2, -3), color = "red", linetype = "dashed") +
  labs(
      title = "Seasonal Linear Model",
      subtitle = "Residuals vs. Fitted",
      x = "Fitted values",
      y = ""
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 11,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 8,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  )

grid.arrange(p1, p2, p3, p4, nrow = 2, ncol = 2)
```
This conclusion is supported by looking at the residual plots, where the seasonal plot is more closely clustered together. However, there is an oscillation to the residuals which is concerning and will hopefully be corrected by an ARIMA model.

### ARIMA Time Series Model

In order to determine an appropriate ARIMA model, we need to analyze the ACF and PACF graphs. However, since we have previously noted that the data are non-stationary, we first need to apply a differencing function. This is shown below:

```{r difference plots, echo=FALSE, warning=FALSE, message=FALSE, fig.width=15, fig.height=7}

diff.plot <- co2_mm_1997 %>%
  ggplot(aes(x = time_index, y = c(NA, diff(average)))) +
  geom_line(
    size = 0.6,
    color = "black"
  ) +
  labs(
      title = "Average CO2 in the Atmosphere (PPM)",
      subtitle = "Lag-Differenced Series",
      x = "Date",
      y = "Average PPM (Difference)"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 20,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 14,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 14,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 12),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

diff.acf <- ACF(
fill_gaps(co2_mm_1997, .full = TRUE),
diff(average)
) %>% autoplot() +
  labs(
      title = "Autocorrelation Function",
      subtitle = "Differenced Average CO2 (PPM)",
      x = "lag [Unit = 1M]",
      y = "Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 20,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 14,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 14,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 12),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

diff.pacf <- PACF(
fill_gaps(co2_mm_1997, .full = TRUE),
diff(average)
) %>% autoplot() +
  labs(
      title = "Partial Autocorrelation Function",
      subtitle = "Differenced Average CO2 (PPM)",
      x = "lag [Unit = 1M]",
      y = "Partial Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 20,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 14,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 14,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 12),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

diff.plot / (diff.acf | diff.pacf)
```

After applying a differencing function, we can see that the data are now stationary. This is validated with the results of the kpss unit root test, where we fail to reject the null hypothesis (p = 0.1) after a first difference. The ACF shows an oscillation which is indicative of a seasonal ARIMA model. We therefore created a SARIMA model that included a differencing term for both the seasonal and non-seasonal elements, and iterated over various autoregressive and moving averages to best optimize the model.

```{r sarima model, echo=FALSE, warning=FALSE}
sarima_model <- co2_mm_1997 %>%
  model(ARIMA(average ~ 1 + pdq(1, 1, 3) + PDQ(2, 1, 2), ic="bic", stepwise=F, greedy=F))
```

Our optimized model was an ARIMA(1,1,3)(2,1,2)[12] model. This is a seasonal model, with a frequency of 12 months. Reviewing the residuals, we can see that between all of the models analyzed so far, it has the best presentation of residuals which are clearly centered around zero with no outputs being over two standard deviations away, and the projection continues to capture the seasonal movements and upward trend.

```{r sarima model plots, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, fig.height=7}
p1 <- augment(sarima_model) %>%
  ggplot(aes(x = .fitted, y = .innov)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept=c(3, 2, -2, -3), color = "red", linetype = "dashed") +
  labs(
      title = "ARIMA(1,1,3)(2,1,2)[12] Model",
      subtitle = "Residuals vs. Fitted",
      x = "Fitted values",
      y = "Standardized \n Pearson residuals"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 22,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )
   
p2 <- augment(sarima_model)%>%
  ggplot(aes(x = time_index)) +
  geom_line(aes(y = average, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) +
  labs(
      title = "Average CO2 in the Atmosphere (PPM)",
      subtitle = "+ ARIMA(1,1,3)(2,1,2)[12] Model Forecast",
      x = "Date",
      y = "Average PPM"
      ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 22,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  ) +
  autolayer(forecast(sarima_model, h=276), colour="blue")

grid.arrange(p1, p2, nrow = 1, ncol = 2)
```

```{r residual analysis sarima, echo=FALSE}
resid.ts <- sarima_model %>%
  augment() %>%
  select(.resid) %>%
  as.ts()

#Box.test(resid.ts, lag=1, type="Ljung-Box")
#Box.test(resid.ts, lag=10, type="Ljung-Box")
```
When we run the Box-Ljung test, we get a favorable p-value of 0.8086 at lag 1 and 0.6967 at lag 10. Since the p-value is above 0.05 in both cases, we fail to reject the null hypothesis that the data is independently distributed. 

## Forecast Atmospheric CO$_{2}$ Growth

The graph below shows the projection of both the linear model (incl. seasonal and quadratic components) and the SARIMA model projected several decades into the future:

```{r forecast plot, echo=FALSE, fig.height=3}
amt = 1524

autoplot(co2_mm_1997, .vars = average) +
  autolayer(forecast(sarima_model, h=amt), colour="blue") +
  autolayer(forecast(seasonal_linear, h=amt), colour="darkgreen") + 
  ggtitle("Projection of CO2 in the Atmosphere (PPM)") +
  xlab("Month") +
  ylab("Average PPM") +
  geom_hline(yintercept = 420, color="red") +
  geom_hline(yintercept = 500, color="red") +
  annotate("text", x= yearmonth("2094 Jan"), y=750, label="Linear Model", color="darkgreen", size = 3) +
  annotate("text", x= yearmonth("2090 Jan"), y=520, label="SARIMA Model", color="blue", size = 3) +
  annotate("text", x= yearmonth("1965 Jan"), y=435, label="420 PPM", color="red", size = 3) +
  annotate("text", x= yearmonth("1965 Jan"), y=515, label="500 PPM", color="red", size = 3) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 11,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 9,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 9,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 8),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  ) 
```

The models produce somewhat different predictions. As a result the models are expected to hit 420 and leave 500 in approximately the following years:

```{r determine the different years for confidence interval, echo=FALSE}
#Uncomment to find years for linear model and SARIMA model

#forecast(seasonal_linear, h=amt) %>%
#  hilo(level=c(95))

#forecast(sarima_model, h=amt) %>%
#  hilo(level=c(95))

```


| Model           |420 PPM (Point)|420 PPM (First)|420 PPM (Last) |500 PPM (Point)|500 PPM (First)|500 PPM (Last)|
|-----------------|---------------|---------------|---------------|---------------|---------------|--------------|
| Linear          | 2022 May      | 2022 Mar      | 2023 Apr      | 2051 Apr      | 2033 May      | 2052 Apr     |
| SARIMA          | 2025 Apr      | 2019 Apr      | 2035 Apr      | 2056 Mar      | 2044 May      | 2076 Apr     |

The "point" indicator is the expected time. The "first" indicator is the month and year in which the upper bound of the 95% confidence interval crosses the PPM threshold, whereas the "last" indicator is the month and year in which the lower bound of the confidence interval crosses the PPM threshold. We can see that the SARIMA model crosses the threshold much slower, and there is a wider confidence interval. 

When we look at year 2100, the SARIMA model projects that the CO$_{2}$ in the atmosphere will be close to 650PPM whereas the linear model projects there will be close to 700 PPM. There is, however, a wider range of results for the SARIMA model that can put the projections above and below the linear model and is illustrative of a higher level of model uncertainty. Ultimately, according to our calculations the Linear Model produces more stable results as the confidence interval is much narrower. The much broader confidence interval of the SARIMA model makes it less precise as a forecasting tool.

# 2023 Review of 1997 CO$_{2}$ Report

## Introduction

In the following analysis, we would like to determine how well our best model trained on pre-1997 CO$_{2}$ concentration data collected at the Mauna Loa observatory performs against data collected post-1997. There were no major technical changes to the measurement from 1997 - 2019, but in that year a new CO$_{2}$ detector based upon Cavity Ring-Down Spectroscopy (CRDS) was installed ^[https://gml.noaa.gov/ccgg/about/co2_measurements.html]. While it is fundamentally different to the previous method of infrared absorption, robust calibration of the CRDS analyzer ensures that data from both instruments can be used in conjunction during modelling without issue. 

## Data Pipeline

A data pipeline was created to pull and clean atmospheric CO$_{2}$ concentration data hosted online by the NOAA Global Monitoring Laboratory. 

```{r data pipeline, echo = FALSE, message = FALSE}
co2_present <-  read.csv('https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_weekly_mlo.csv', header = TRUE, sep = ",", skip = 35) %>%
  filter(
    average != -999.99 
  ) %>%
  mutate(
    time_index = lubridate::make_date(year, month, day)
  ) %>%
  select(
    average, time_index
  ) %>%
  filter(
    time_index >= as.Date("1997-01-01") 
  ) %>%
  as_tsibble(index = time_index)

co2_present <- fill_gaps(co2_present, .full=TRUE)
```

```{r initial plots present, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, fig.height=10}
co2_present_smooth <- co2_present |>
  mutate(
    `MA-present` = slider::slide_dbl(average, mean,
                .before = 12, .after = 0, .complete = TRUE)
  )

co2_present_plot_timeseries <- co2_present %>%
  ggplot(aes(x = time_index, y = average)) +
  geom_line() +
  geom_smooth() +
  labs(
    x = "Month",
    y = "Average PPM",
    title = "Average CO2 (PPM)"
  ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

co2_present_plot_boxplot <- co2_present %>%
  ggplot(aes(x = as.factor(month(time_index)), y = average)) +
  geom_boxplot() +
  labs(
    x = "Month",
    y = "Average PPM",
    title = "Boxplot of Monthly Average CO2 (PPM)"
  ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  )

co2acf <- ACF(
    fill_gaps(co2_present, .full = TRUE), 
    average
  ) %>% autoplot() + labs(
    x = "lag [Unit = 1M]",
    y = "Autocorrelation",
    title = "Autocorrelation Function",
    subtitle = "Average CO2 (PPM)"
  ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 22,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  ) + scale_x_continuous(breaks = c(0,6,12,18,24,30))

co2pacf <- PACF(
    fill_gaps(co2_present, .full = TRUE), 
    average
  ) %>% autoplot() + labs(
    x = "lag [Unit = 1M]",
    y = "Partial Autocorrelation",
    title = "Partial Autocorrelation Function",
    subtitle = "Average CO2 (PPM)"
  ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 22,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  ) + scale_x_continuous(breaks = c(0,6,12,18,24,30))

co2_present_plot_timeseries + co2_present_plot_boxplot + co2acf + co2pacf
```

The EDA plots above suggest that the series post-1997 is similar to pre-1997 data, with a strong auto-regressive and seasonal component. 

## Compare Linear Model forecasts agaisnt realized CO$_{2}$

In the left plot below we show the forecast of the linear model (in green) against the true data (in black). For such a simple model the fit is surprisingly close. The right plot shows the difference between the model and data. It is noteworthy that the difference does not appear stationary and seems to increasingly under-estimate the measured atmospheric CO$_{2}$ concentrations as time passes. 

```{r convert present co2 package to tsibble, echo=FALSE}
#Create monthly dataset
co2_present_month <- 
  co2_present[which(year(co2_present$time_index) > 1996), ] %>%
  mutate(time_index = yearmonth(time_index))
co2_present_month <- 
  aggregate(co2_present_month$average, list(co2_present_month$time_index), FUN=mean) %>%
  dplyr::rename(time_index = Group.1, average = x) %>%
  as_tsibble(index=time_index)
```

```{r linear comparison plots, echo = FALSE, message = FALSE, warning = FALSE, fig.width=20, fig.height=7}
My_Theme = theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 22,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 20,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 20),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  )

amt = 310

start_date <- as_date(min(co2_present$time_index))
end_date <- as_date(min(co2_present$time_index))

new_dates <- data.frame(seq(start_date, end_date, by = 'month')) %>%
  dplyr::rename(
    time_index = names(.)[1]
  ) %>%
  tsibble::as_tsibble(index = time_index)

a1 <- autoplot(co2_mm_1997, .vars = average) +
  autolayer(co2_present, .vars = average, colour="black") + 
  autolayer(forecast(seasonal_linear, h=amt), colour="darkgreen", alpha = 0.35) +
  labs(
      title = "Average CO2 in the Atmosphere (PPM)",
      subtitle = "compared to Linear Projection (PPM)",
      x = "Month",
      y = "Average PPM"
    ) +
  # theme(plot.title = element_text(size=15, hjust = 0.5),legend.position = "upper left") +
  annotate("text", x= yearmonth("2010 Jan"), y=415, label="Linear Model", color="darkgreen", size = 6) +
  annotate("text", x= yearmonth("2016 Jan"), y=380, label="Real CO2 Levels", color="black", size = 6) + 
  ylim(310, 425) +
  My_Theme

forecast_h = 311

forecast_data <- co2_present_month %>%
  filter(
    time_index >= as_date(min(forecast(seasonal_linear, h = forecast_h)$time_index))
  ) %>%
  mutate(
    difference = average - forecast(seasonal_linear, h = forecast_h)$.mean
  )

a2 <- forecast_data %>%
  ggplot(aes(x= time_index , y = difference)) + 
  geom_line() +
  labs(
      title = "Difference Between Measured and Forecast",
      subtitle = "Using Linear Projection",
      x = "Month",
      y = "Diff in Average PPM"
    ) +
  # theme(plot.title = element_text(size=15, hjust = 0.5),legend.position = "upper left") +
  ylim(-2,6) +
  My_Theme

(a1 + a2)

```

## Compare ARIMA models forecasts against realized CO2

In the left plot below we show the forecast of the selected ARIMA model (in blue) against the true data (in black). The model fit is quite similar to the linear model, though the non-stationarity of the difference (right plot) is much stronger, more than twice as high in the ARMIA model versus the seasonal linear at the furthest forecast dates.

```{r arima comparison plots, echo = FALSE, message = FALSE, warning = FALSE, fig.width=20, fig.height=7}
a3 <- autoplot(co2_mm_1997, .vars = average) +
  autolayer(co2_present, .vars = average, colour="black") + 
  autolayer(forecast(sarima_model, h=amt), colour="blue", alpha = 0.35) +
  labs(
      title = "Average CO2 in the Atmosphere (PPM)",
      subtitle = "compared to ARIMA Projection (PPM)",
      x = "Month",
      y = "Average PPM"
    ) +
  # theme(plot.title = element_text(size=15, hjust = 0.5),legend.position = "upper left") +
  annotate("text", x= yearmonth("2015 Jan"), y=370, label="SARIMA Model", color="blue", size = 6) +
  annotate("text", x= yearmonth("2010 Jan"), y=420, label="Real CO2 Levels", color="black", size = 6) +
  ylim(310, 425) +
  My_Theme

forecast_data <- co2_present_month %>%
  filter(
    time_index >= as_date(min(forecast(sarima_model, h = forecast_h)$time_index))
  ) %>%
  mutate(
    difference = average - forecast(sarima_model, h = forecast_h)$.mean
  )

a4 <- forecast_data %>%
  ggplot(aes(x= time_index , y = difference)) + 
  labs(
      title = "Difference Between Measured and Forecast",
      subtitle = "Using ARIMA Projection",
      x = "Month",
      y = "Diff in Average PPM"
    ) +
  geom_line() +
  theme(plot.title = element_text(size=15, hjust = 0.5),legend.position = "upper left") + 
  ylim(-2,6) +
  My_Theme

(a3 + a4)

```

## Evaluate the performance of 1997 linear and ARIMA models

The first recorded time in the weekly data that CO2 crosses 420 ppm was in March of 2020. The seasonal linear model predicted May 2022, while the SARIMA model predicted April 2025. The models have 95% intervals of [411.9535, 415.4154] and [397.3001, 423.6106] respectively for March of 2020. (The linear model has a tighter interval and a closer point estimate, while the SARIMA model includes 420 in the CI but has a wider interval and a farther point estimate.) In this regard, the linear model proved to be more accurate as its forecast was only 26 months out vs. the 61 months for the SARIMA model. 

From this information and the above graphs, we can see that neither of the models fully capture the rapid growth in level of atmospheric CO$_{2}$.

```{r month-average series, echo = FALSE, warning = FALSE, message = FALSE}
co2_present_month <- 
  co2_present[which(year(co2_present$time_index) > 1996), ] %>%
  mutate(time_index = yearmonth(time_index))
co2_present_month <- 
  aggregate(co2_present_month$average, list(co2_present_month$time_index), FUN=mean) %>%
  dplyr::rename(time_index = Group.1, average = x) %>%
  as_tsibble(index=time_index)

# fabletools::accuracy(forecast(seasonal_linear), co2_present_month)
# fabletools::accuracy(forecast(sarima_model), co2_present_month)
```

Comparing the root mean squared errors of the models, the linear model has an RMSE of 0.491 while the SARIMA model has an RMSE of 1.23. We therefore conclude that the linear model was the more accurate of the two.

## Train best models on present data

Three models were fit against data from 1997 up to 2022 and tested against the data from 2022 onward. The first was a SARIMA model trained on the raw weekly data, the second was a SARIMA model trained on the seasonally corrected data (only the trend and white noise components of the data), and the final was a polynomial time-trend model based on the same seasonally corrected data.

These are summarized graphically in the following plot and discussed in detail in the sections below.

```{r adjust and split data training test, echo = FALSE, warning = FALSE, warning = FALSE}
co2_nsa_train <- 
  co2_present[which(year(co2_present$time_index) < 2022), ] 

co2_nsa_test <- 
  co2_present[which(year(co2_present$time_index) >= 2022), ] 

co2_sa <- data.frame(stlplus(x = co2_present$average, n.p = 52, s.window = 'periodic')$data['trend'] + 
                       stlplus(x = co2_present$average, n.p = 52, s.window = 'periodic')$data['remainder'], co2_present$time_index) %>%
  dplyr::rename(
    "average" = "trend",
    "time_index" = "co2_present.time_index"
  ) %>%
  tsibble::as_tsibble(index = time_index)

co2_sa_train <- 
  co2_sa[which(year(co2_present$time_index) < 2022), ] 

co2_sa_test <- 
  co2_sa[which(year(co2_present$time_index) >= 2022), ] 
```


```{r build models on test data, echo=FALSE}
#co2_nsa_ARIMA <-
#  co2_nsa_train %>%
#  fill_gaps(.full=TRUE) %>%  model(arima = fable::ARIMA(average ~ 1 + pdq(p= 0:10, d = 0:3, q = 0:10) + PDQ(P = 0:10, D = 1:3, Q = 0:10, period = 52), #ic="bic", approximation = TRUE, stepwise = TRUE, greedy = TRUE))

#saveRDS(co2_nsa_ARIMA, "co2_nsa_ARIMA.Rda")
co2_nsa_ARIMA <- readRDS("co2_nsa_ARIMA.Rda")

#co2_sa_ARIMA <-
#  co2_sa_train %>%
#  fill_gaps(.full=TRUE) %>%
#  model(arima = fable::ARIMA(average ~ 1 + pdq(p= 0:10, d = 1:3, q = 0:10) + PDQ(P = 0:10, D = 0:3, Q = 0:10, period = 52), ic="bic", approximation = TRUE, stepwise = TRUE, greedy = TRUE))
                                                          
#saveRDS(co2_sa_ARIMA, "co2_sa_ARIMA.Rda")
co2_sa_ARIMA <- readRDS("co2_sa_ARIMA.Rda")

co2_sa_poly <- co2_sa_train %>% 
  model(trend_model = TSLM(average ~ 1 + trend() + I(trend()^2)))
```

```{r nsa arima, echo = FALSE, message = FALSE, warning = FALSE, fig.width=20, fig.height=14}
new_forecast = 97

My_Theme_Grid = theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 28,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 20,
                               face = "bold.italic"),
  axis.title = element_text(color = "#969696",
                            size = 16),
  axis.text = element_text(color = "#969696", size = 16),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696"),
  legend.position = "none"
  )

a1 <- autoplot(co2_nsa_train, .vars = average, colour="black") + 
  autolayer(augment(co2_nsa_ARIMA), colour="darkgreen", alpha = 0.50) +
  autolayer(co2_nsa_test, .vars = average, colour="black") +
  autolayer(forecast(co2_nsa_ARIMA, h=new_forecast), colour="darkgreen", alpha = 0.35) + 
  labs(
      title = "Non Seasonally Adjusted \n ARIMA Model",
      subtitle = "Atmospheric CO2 Concentration over Time",
      x = "Time",
      y = "CO2 Concentration (ppm)"
  ) +
  ylim(360, 440) +
  My_Theme_Grid

a2 <- autoplot(co2_sa_train, .vars = average, colour="black") + 
  autolayer(augment(co2_sa_ARIMA), colour="darkgreen", alpha = 0.50) + 
  autolayer(co2_sa_test, .vars = average, colour="black") +
  autolayer(forecast(co2_sa_ARIMA, h=new_forecast), colour="darkgreen", alpha = 0.35) + 
  labs(
      title = "Seasonally Adjusted \n ARIMA Model",
      subtitle = "Atmospheric CO2 Concentration over Time",
      x = "Time",
      y = NULL
  ) +
  xlim(as.Date(c("1997-01-01", "2023-11-01"))) +
  ylim(360, 440) +
  My_Theme_Grid

a3 <- autoplot(co2_sa_train, .vars = average, colour="black") + 
  autolayer(augment(co2_sa_poly), colour="darkgreen", alpha = 0.50) + 
  autolayer(co2_sa_test, .vars = average, colour="black") +
  autolayer(forecast(co2_sa_poly, h=new_forecast), colour="darkgreen", alpha = 0.35) + 
    labs(
      title = "Seasonally Adjusted \n Linear Model",
      subtitle = "Atmospheric CO2 Concentration over Time",
      x = "Time",
      y = NULL
  ) +
  xlim(as.Date(c("1997-01-01", "2023-11-01"))) +
  ylim(360, 440) +
  My_Theme_Grid

res1 <- augment(co2_nsa_ARIMA) %>%
  ggplot(aes(x = .fitted, y = .innov)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept=c(3, 2, -2, -3), color = "red", linetype = "dashed") +
  labs(
      title = NULL,
      subtitle = "Training Set Residuals",
      x = "Time",
      y = "Standard Pearson Residuals"
  ) +
  My_Theme_Grid

res2 <- augment(co2_sa_ARIMA) %>%
  ggplot(aes(x = .fitted, y = .innov)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept=c(3, 2, -2, -3), color = "red", linetype = "dashed") +
  labs(
      title = NULL,
      subtitle = "Training Set Residuals",
      x = "CO2 concentration (ppm)",
      y = NULL
  ) +
  My_Theme_Grid

res3 <- augment(co2_sa_poly) %>%
  ggplot(aes(x = .fitted, y = .innov)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept=c(3, 2, -2, -3), color = "red", linetype = "dashed") +
  labs(
      title = NULL,
      subtitle = "Training Set Residuals",
      x = "CO2 concentration (ppm)",
      y = NULL
  ) +
  My_Theme_Grid

nsa_forecast_data <- co2_nsa_test %>%
  filter(
    time_index >= as_date(min(forecast(co2_nsa_ARIMA, h = new_forecast)$time_index))
  ) %>%
  mutate(
    difference = average - forecast(co2_nsa_ARIMA, h = new_forecast)$.mean
  )

test1 <- nsa_forecast_data %>%
  ggplot(aes(x= time_index , y = difference)) + 
  geom_line() +
  labs(
      title = NULL,
      subtitle = "Test Set Difference",
      x = "Time",
      y = paste("Actual - Forecast CO2 (ppm)")
  ) +
  ylim(-3,2) +
  My_Theme_Grid

sa_forecast_data <- co2_sa_test %>%
  filter(
    time_index >= as_date(min(forecast(co2_sa_ARIMA, h = new_forecast)$time_index))
  ) %>%
  mutate(
    difference = average - forecast(co2_sa_ARIMA, h = new_forecast)$.mean
  )

test2 <- sa_forecast_data %>%
  ggplot(aes(x= time_index , y = difference)) + 
  geom_line() +
  labs(
      title = NULL,
      subtitle = "Test Set Difference",
      x = "Time",
      y = NULL
  ) +
  ylim(-3,2) +
  My_Theme_Grid

poly_forecast_data <- co2_sa_test %>%
  filter(
    time_index >= as_date(min(forecast(co2_sa_poly, h = new_forecast)$time_index))
  ) %>%
  mutate(
    difference = average - forecast(co2_sa_poly, h = new_forecast)$.mean
  )

test3 <- poly_forecast_data %>%
  ggplot(aes(x= time_index , y = difference)) + 
  geom_line() +
  labs(
      title = NULL,
      subtitle = "Test Set Difference",
      x = "Time",
      y = NULL
  ) +
  ylim(-3,2) +
  My_Theme_Grid

(a1 + a2 + a3) / (res1 + res2 + res3) / (test1 + test2 + test3)
```

### Non Seasonally Adjusted ARIMA Model
$$ARIMA(1,0,2)(1,1,0)[52] \textrm{ w/ drift}$$
Similar to the 1977 report, differencing of the time series of the model is required to make the data stationary. This is validated in the unit root test, where we get a p-value of 0.1 after a first difference. This was the motivation to force a difference term for the seasonal component of the SARIMA search. Again, similarly to the optimized model in 1977, we can see an oscillation in the ACF which is indicative of a ARIMA model. There is also still some oscillation in the PACF for this model that are likely due to the difficulty in paramter search for a series with a relatively large period of 52. 

```{r nsa unit root test, echo=FALSE}
#co2_nsa_train %>% features(average, unitroot_kpss)
#co2_nsa_train %>% mutate(diff_value = difference(average)) %>% features(diff_value, unitroot_kpss)
```

```{r nsa diff plots, echo=FALSE, warning=FALSE, fig.height = 2.8}

nsa.diff.plot <- co2_nsa_train %>%
  ggplot(aes(x = time_index, y = c(NA, diff(average)))) +
  geom_line(
    size = 0.2,
    color = "black"
  ) +
  labs(
      title = "Average CO2 in the Atmosphere (PPM)",
      subtitle = "Non Seasonally Adjusted ARIMA Model Lag-Differenced Series",
      x = "Date",
      y = "Average PPM \n (Difference)"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 9,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 6,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 5,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 5),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  ) 

nsa.diff.acf <- ACF(
fill_gaps(co2_nsa_train, .full = TRUE),
diff(average)
) %>% autoplot() +
  labs(
      title = "Autocorrelation Function",
      subtitle = "Differenced NSA Model - Average CO2 (PPM)",
      x = "lag [Unit = 7D]",
      y = "Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 9,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 6,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 5,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 5),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  ) + scale_x_continuous(breaks = c(0,7,14,21,28))

nsa.diff.pacf <- PACF(
fill_gaps(co2_nsa_train, .full = TRUE),
diff(average)
) %>% autoplot() +
  labs(
      title = "Partial Autocorrelation Function",
      subtitle = "Differenced NSA Model - Average CO2 (PPM)",
      x = "lag [Unit = 7D]",
      y = "Partial Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 9,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 6,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 5,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 5),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  ) + scale_x_continuous(breaks = c(0,7,14,21,28))

nsa.diff.plot / (nsa.diff.acf | nsa.diff.pacf)
```

When we review the residuals of the model we can see that they are closely centered around zero, and the projection of the model track well against the test set data. We also ran the Ljung-Box test and we failed to reject the null hypothesis that all auto-correlations are zero in the time series at lag 1 (p=0.419), but can reject at lag 10 (p=0.0153), suggesting some residual auto-correlation that is not captured in the seasonal model.


```{r nsa armia box leung, echo = FALSE}
#Box.test(residuals(co2_nsa_ARIMA)['.resid'], lag=1, type="Ljung-Box")
#Box.test(residuals(co2_nsa_ARIMA)['.resid'], lag=10, type="Ljung-Box")
```

```{r nsa accuracy, echo=FALSE}
#fabletools::accuracy(forecast(co2_nsa_ARIMA, h = new_forecast), co2_nsa_test)
```

A RMSE of 0.734 was calculated for this model against the test set.

### Seasonally Adjusted ARIMA Model
$$ARIMA(0,1,2) \textrm{ w/ drift}$$
Similar to the non-seasonally adjusted model, these data were suspected to be non-stationary and therefore a differencing function needed to be added. This is validated in the unit root test, where we also get a p-value of 0.1 after a first difference. This was the motivation to force a difference term in the arima search.

```{r sa unit root test, echo=FALSE}
#co2_sa_train %>% features(average, unitroot_kpss)
#co2_sa_train %>% mutate(diff_value = difference(average)) %>% features(diff_value, unitroot_kpss)
```

```{r sa diff plots, echo=FALSE, warning=FALSE, fig.height = 2.8}
sa.diff.plot <- co2_sa_train %>%
  ggplot(aes(x = time_index, y = c(NA, diff(average)))) +
  geom_line(
    size = 0.2,
    color = "black"
  ) +
  labs(
      title = "Average CO2 in the Atmosphere (PPM)",
      subtitle = "Seasonally Adjusted ARIMA Model Lag-Differenced Series",
      x = "Date",
      y = "Average PPM \n (Difference)"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 9,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 6,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 5,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 5),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  ) 

sa.diff.acf <- ACF(
fill_gaps(co2_sa_train, .full = TRUE),
diff(average)
) %>% autoplot() +
  labs(
      title = "Autocorrelation Function",
      subtitle = "Differenced SA Model - Average CO2 (PPM)",
      x = "lag [Unit = 7D]",
      y = "Autocorrelation"
    ) +
  theme_classic() +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 9,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 6,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 5,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 5),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  ) + scale_x_continuous(breaks = c(0,7,14,21,28))

sa.diff.pacf <- PACF(
fill_gaps(co2_sa_train, .full = TRUE),
diff(average)
) %>% autoplot() +
  labs(
      title = "Partial Autocorrelation Function",
      subtitle = "Differenced SA Model - Average CO2 (PPM)",
      x = "lag [Unit = 7D]",
      y = "Partial Autocorrelation"
    ) +
  theme(
  plot.title = element_text(color = "#0099F8",
                            size = 9,
                            face = "bold"),
  plot.subtitle = element_text(color="#969696",
                               size = 6,
                               face = "italic"),
  axis.title = element_text(color = "#969696",
                            size = 5,
                            face = "bold"),
  axis.text = element_text(color = "#969696", size = 5),
  axis.line = element_line(color = "#969696"),
  axis.ticks = element_line(color = "#969696")
  ) + scale_x_continuous(breaks = c(0,7,14,21,28))

sa.diff.plot / (sa.diff.acf | sa.diff.pacf)
```

There are some key differences vs. our non-seasonally adjusted model. The first is that there is less uniformity in the time series and the residual difference looks more like white noise. Also, while there is still an oscillation in the ACF, fewer of the spikes are significant. The PACF also shows a more sensible exponential fall-off. Running the Box-Leung test, we fail to reject the null hypothesis for lags of both 1 and 10 suggesting that the model has captured sufficient autocorrelative behaviour in the series. 

```{r sa armia box leung, echo = FALSE}
#Box.test(residuals(co2_sa_ARIMA)['.resid'], lag=1, type="Ljung-Box")
#Box.test(residuals(co2_sa_ARIMA)['.resid'], lag=10, type="Ljung-Box")
```

```{r poly accuracy, echo=FALSE}
#fabletools::accuracy(forecast(co2_sa_ARIMA, h = new_forecast), co2_sa_test)
```
The calculated RMSE for this model against test data is 0.620, which shows a slight improvement against the non-seasonally adjusted SARIMA model.

```{r sa accuracy, echo=FALSE}
# fabletools::accuracy(forecast(co2_sa_ARIMA_v2), co2_sa_test_v2)
```

### Seasonally Adjusted Polynomial Linear Model
$$3.64\times 10^{2} + lag \times 3.26\times 10^{-2} + lag^2 \times 6.76\times 10^{-6}$$
In the 1977 report, the best performing model was the linear model. We therefore also trialed optimizing a linear model with a quadratic elements on the training data.

When we review the projection and residuals for this model, the mean of the residuals doesn't follow as straight of a line as for the ARIMA models. Similar to the pre-1997 data modelling, it had the best performance on the test data with an RMSE of 0.426.

```{r, echo=FALSE}
#fabletools::accuracy(forecast(co2_sa_poly), co2_sa_test)
```

## How bad could it get?

Estimates are provided in the Tables below for when the atmospheric concentration of CO$_{2}$ are expected to breach 420PPM and 500PPM. While the seasonally adjusted and non-adjusted ARIMA models are fairly consistent in estimates for each, the polynomial model predicts much higher values. The University Corporation for Atmospheric Research ^[https://scied.ucar.edu/interactive/climate-sensitivity-calculator] suggests that the climate sensitivity parameter, or the rise in mean global temperature per doubling of atmospheric CO$_{2}$ values, is approximately 3C. Both of the ARIMA models are similar in their predictions, but worryingly, the historically more accurate quadratic model is predicting that an atmospheric concentration will be reached over a decade earlier, and that by 2122 the global mean temperature will be significantly (>1.5C) warmer on average than predicted by either of the ARIMA models.

```{r prediction forecast, echo = FALSE, message= FALSE, warnings = FALSE}
nsa_level <- forecast(co2_nsa_ARIMA, h=7500) %>%
  hilo(level=c(95))

sa_level <- forecast(co2_sa_ARIMA, h=7500) %>%
  hilo(level=c(95))

poly_level <- forecast(co2_sa_poly, h=7500) %>%
  hilo(level=c(95))

ls_level <- forecast(seasonal_linear, h=7500) %>%
  hilo(level=c(95))

sarima_level <- forecast(sarima_model, h=7500) %>%
  hilo(level=c(95))
```

```{r specific predictions, echo = FALSE, message= FALSE, warnings = FALSE}
set_concentration = 420

ls_420_low <-
  ls_level$time_index[Position(function(x) x > set_concentration, ls_level$`95%`$lower)]
ls_420_mid <-
  ls_level$time_index[Position(function(x) x > set_concentration, ls_level$.mean)]
ls_420_high <-
  ls_level$time_index[Position(function(x) x > set_concentration, ls_level$`95%`$upper)]

sarima_420_low <-
  sarima_level$time_index[Position(function(x) x > set_concentration, sarima_level$`95%`$lower)]
sarima_420_mid <-
  sarima_level$time_index[Position(function(x) x > set_concentration, sarima_level$.mean)]
sarima_420_high <-
  sarima_level$time_index[Position(function(x) x > set_concentration, sarima_level$`95%`$upper)]

nsa_420_low <-
  nsa_level$time_index[Position(function(x) x > set_concentration, nsa_level$`95%`$lower)]
nsa_420_mid <-
  nsa_level$time_index[Position(function(x) x > set_concentration, nsa_level$.mean)]
nsa_420_high <-
  nsa_level$time_index[Position(function(x) x > set_concentration, nsa_level$`95%`$upper)]

sa_420_low <-
  sa_level$time_index[Position(function(x) x > set_concentration, sa_level$`95%`$lower)]
sa_420_mid <-
  sa_level$time_index[Position(function(x) x > set_concentration, sa_level$.mean)]
sa_420_high <-
  sa_level$time_index[Position(function(x) x > set_concentration, sa_level$`95%`$upper)]

poly_420_low <-
  poly_level$time_index[Position(function(x) x > set_concentration, poly_level$`95%`$lower)]
poly_420_mid <-
  poly_level$time_index[Position(function(x) x > set_concentration, poly_level$.mean)]
poly_420_high <-
  poly_level$time_index[Position(function(x) x > set_concentration, poly_level$`95%`$upper)]

set_concentration = 500

ls_500_low <-
  ls_level$time_index[Position(function(x) x > set_concentration, ls_level$`95%`$lower)]
ls_500_mid <-
  ls_level$time_index[Position(function(x) x > set_concentration, ls_level$.mean)]
ls_500_high <-
  ls_level$time_index[Position(function(x) x > set_concentration, ls_level$`95%`$upper)]

sarima_500_low <-
  sarima_level$time_index[Position(function(x) x > set_concentration, sarima_level$`95%`$lower)]
sarima_500_mid <-
  sarima_level$time_index[Position(function(x) x > set_concentration, sarima_level$.mean)]
sarima_500_high <-
  sarima_level$time_index[Position(function(x) x > set_concentration, sarima_level$`95%`$upper)]

nsa_500_low <-
  nsa_level$time_index[Position(function(x) x > set_concentration, nsa_level$`95%`$lower)]
nsa_500_mid <-
  nsa_level$time_index[Position(function(x) x > set_concentration, nsa_level$.mean)]
nsa_500_high <-
  nsa_level$time_index[Position(function(x) x > set_concentration, nsa_level$`95%`$upper)]

sa_500_low <-
  sa_level$time_index[Position(function(x) x > set_concentration, sa_level$`95%`$lower)]
sa_500_mid <-
  sa_level$time_index[Position(function(x) x > set_concentration, sa_level$.mean)]
sa_500_high <-
  sa_level$time_index[Position(function(x) x > set_concentration, sa_level$`95%`$upper)]

poly_500_low <-
  poly_level$time_index[Position(function(x) x > set_concentration, poly_level$`95%`$lower)]
poly_500_mid <-
  poly_level$time_index[Position(function(x) x > set_concentration, poly_level$.mean)]
poly_500_high <-
  poly_level$time_index[Position(function(x) x > set_concentration, poly_level$`95%`$upper)]
```

\captionsetup[table]{labelformat=empty}

```{r table of estimates, echo= FALSE, message = FALSE, warning = FALSE, tab.cap = NULL, results='asis', fig.cap="Estimates for when atmospheric CO2 concentrations will reach 420ppm and 500ppm for various models. Low, median and high values correspond to when the 95pct confidence envelope of the prediction intersects the 420ppm and 500ppm values respectively."}
estimates <- data.frame(
  "Type" = c("Linear", "SARIMA", "SARIMA (New)", "ARIMA (New)", "Linear (New)"),
  "420 ppm (low)" = c("2022 Mar", "2019 Apr", as.character(nsa_420_low), as.character(sa_420_low), as.character(poly_420_low)),
  "420 ppm (point)" = c("2022 May", "2025 Apr", as.character(nsa_420_mid), as.character(sa_420_mid), as.character(poly_420_mid)),
  "420 ppm (high)" = c("2023 Apr", "2035 Apr", as.character(nsa_420_high), as.character(sa_420_high), as.character(poly_420_high)),
  "500 ppm (low)" = c("2033 May", "2044 May", as.character(nsa_500_low), as.character(sa_500_low), as.character(poly_500_low)),
  "500 ppm (point)" = c("2051 Apr", "2056 Mar", as.character(nsa_500_mid), as.character(sa_500_mid), as.character(poly_500_mid)),
  "500 ppm (high)" = c("2052 Apr", "2076 Apr", as.character(nsa_500_high), as.character(sa_500_high), as.character(poly_500_high))
)

knitr::kable(estimates, booklines = TRUE, col.names = c("Model", "420 (low)", "420 (mean)", "420 (high)", "500 (low)", "500 (mean)", "500 ppm (high)"), 'pipe', table.envir = "figure", format = "pandoc")
```

```{r individual estiamtes, echo = FALSE, message = FALSE, warning = FALSE, results = 'asis', fig.cap = "Estimates for atmospheric CO2 concentrations in 2122 for various models. Low, median and high values correspond to the 95pct confidence envelope of the predictions."}
forecast_time = as.Date("2122-01-01")

ls_2122_low <-
  ls_level$`95%`$lower[Position(function(x) x > forecast_time, ls_level$time_index)]
ls_2122_mid <-
  ls_level$.mean[Position(function(x) x > forecast_time, ls_level$time_index)]
ls_2122_high <-
  ls_level$`95%`$upper[Position(function(x) x > forecast_time, ls_level$time_index)]

sarima_2122_low <-
  nsa_level$`95%`$lower[Position(function(x) x > forecast_time, sarima_level$time_index)]
sarima_2122_mid <-
  nsa_level$.mean[Position(function(x) x > forecast_time, sarima_level$time_index)]
sarima_2122_high <-
  nsa_level$`95%`$upper[Position(function(x) x > forecast_time, sarima_level$time_index)]

nsa_2122_low <-
  nsa_level$`95%`$lower[Position(function(x) x > forecast_time, nsa_level$time_index)]
nsa_2122_mid <-
  nsa_level$.mean[Position(function(x) x > forecast_time, nsa_level$time_index)]
nsa_2122_high <-
  nsa_level$`95%`$upper[Position(function(x) x > forecast_time, nsa_level$time_index)]

sa_2122_low <-
  sa_level$`95%`$lower[Position(function(x) x > forecast_time, sa_level$time_index)]
sa_2122_mid <-
  sa_level$.mean[Position(function(x) x > forecast_time, sa_level$time_index)]
sa_2122_high <-
  sa_level$`95%`$upper[Position(function(x) x > forecast_time, sa_level$time_index)]

poly_2122_low <-
  poly_level$`95%`$lower[Position(function(x) x > forecast_time, poly_level$time_index)]
poly_2122_mid <-
  poly_level$.mean[Position(function(x) x > forecast_time, poly_level$time_index)]
poly_2122_high <-
  poly_level$`95%`$upper[Position(function(x) x > forecast_time, poly_level$time_index)]

estimates_2122 <- data.frame(
  "Type" = c("Linear", "SARIMA", "SARIMA (New)", "ARIMA (New)", "Linear (New)"),
  "2122 Low" = as.double(c(ls_2122_low, sarima_2122_low, nsa_2122_low, sa_2122_low, poly_2122_low)),
  "2122 Mean" = as.double(c(ls_2122_mid, sarima_2122_mid, nsa_2122_mid, sa_2122_mid, poly_2122_mid)),
  "2122 High" = as.double(c(ls_2122_high, sarima_2122_high, nsa_2122_high, sa_2122_high, poly_2122_high))
)

knitr::kable(estimates_2122, booklines = TRUE, col.names = c("Type", "2122 Low", "2122 Mean", "2122 High"), "pipe")
```

